function loadMap(locations){for(var location_id in locations)if(locations.hasOwnProperty(location_id)){var location=locations[location_id],marker=new google.maps.Marker({position:{lat:location.latitude-0,lng:location.longitude-0},map:map,title:location.name});marker.content='<div class="infowindow"><h3>'+formatLink(location.url,location.name,"post_type")+"</h3><address>"+location.address+"<br>"+location.city+(location.state?", "+location.state:"")+"</address>";for(var current_day=null,i=0;i<location.meetings.length;i++){var meeting=location.meetings[i];current_day!=meeting.day&&(current_day&&(marker.content+="</dl>"),current_day=meeting.day,"undefined"!=typeof days[current_day]&&(marker.content+="<h5>"+days[current_day]+"</h5>"),marker.content+="<dl>"),marker.content+="<dt>"+meeting.time+"</dt><dd>"+formatLink(meeting.url,meeting.name,"post_type")+"</dd>"}marker.content+="</dl></div>",google.maps.event.addListener(marker,"click",function(marker){return function(){infowindow.setContent(marker.content),infowindow.open(map,marker)}}(marker)),bounds.extend(marker.position),markers[markers.length]=marker}markers.length>1?map.fitBounds(bounds):1==markers.length?(map.setCenter(bounds.getCenter()),$("#map").is(":visible")&&google.maps.event.trigger(markers[0],"click"),map.setZoom(14)):0==markers.length}function formatLink(url,text,exclude){for(var query_pairs=location.search.substr(1).split("&"),new_query_pairs=[],i=0;i<query_pairs.length;i++){var query_parts=query_pairs[i].split("=");query_parts[0]!=exclude&&(new_query_pairs[new_query_pairs.length]=query_parts[0]+"="+query_parts[1])}return new_query_pairs.length&&(url+=(-1==url.indexOf("?")?"?":"&")+new_query_pairs.join("&")),'<a href="'+url+'">'+text+"</a>"}function updateQueryString(key,value,url){url||(url=window.location.href);var hash,re=new RegExp("([?&])"+key+"=.*?(&|#|$)(.*)","gi");if(re.test(url))return"undefined"!=typeof value&&null!==value?url.replace(re,"$1"+key+"="+value+"$2$3"):(hash=url.split("#"),url=hash[0].replace(re,"$1$3").replace(/(&|\?)$/,""),"undefined"!=typeof hash[1]&&null!==hash[1]&&(url+="#"+hash[1]),url);if("undefined"!=typeof value&&null!==value){var separator=-1!==url.indexOf("?")?"&":"?";return hash=url.split("#"),url=hash[0]+separator+key+"="+value,"undefined"!=typeof hash[1]&&null!==hash[1]&&(url+="#"+hash[1]),url}return url}jQuery(function($){function doSearch(){var data={action:"meetings",search:$("#search input[name=query]").val().trim(),day:$("#day li.active a").attr("data-id"),time:$("#time li.active a").attr("data-id"),region:$("#region li.active a").attr("data-id"),type:$("#type li.active a").attr("data-id")},querystring={};if(data.search&&(querystring.sq=data.search),querystring.d=data.day?data.day:"any",data.time&&(querystring.i=data.time),data.region&&(querystring.r=data.region),data.type&&(querystring.t=data.type),querystring.v=$("#meetings .toggle-view.active").attr("data-id"),querystring=jQuery.param(querystring),history.pushState){var url=window.location.protocol+"//"+window.location.host+window.location.pathname;querystring.length&&(url=url+"?"+querystring),location.search.indexOf("post_type=meetings")>-1&&(url=url+(url.indexOf("?")>-1?"&":"?")+"post_type=meetings"),window.history.pushState({path:url},"",url)}var search=[];if(data.search){search=data.search.split(" ");for(var i=0;i<search.length;i++)search[i]=new RegExp("("+search[i]+")","gi")}jQuery.post(myAjax.ajaxurl,data,function(response){if(response.length){$("#meetings table").removeClass("hidden"),$("#meetings #map").hasClass("hidden")&&($("#meetings #map").removeClass("hidden"),google.maps.event.trigger(map,"resize")),$("#alert").addClass("hidden");var locations=[],tbody=$("#meetings_tbody").html("");jQuery.each(response,function(index,obj){-1!=jQuery.inArray("M",obj.types)?obj.name+=" <small>Men</small>":-1!=jQuery.inArray("W",obj.types)&&(obj.name+=" <small>Women</small>"),locations[obj.location_id]||(locations[obj.location_id]={name:obj.location,address:obj.address,latitude:obj.latitude,longitude:obj.longitude,city:obj.city,state:obj.state,url:obj.location_url,meetings:[]}),locations[obj.location_id].meetings[locations[obj.location_id].meetings.length]={name:obj.name,time:obj.time_formatted,day:obj.day,notes:obj.notes,url:obj.url};var sort_time=obj.day+"-"+("00:00"==obj.time?"11:59":obj.time);tbody.append('<tr><td class="time" data-sort="'+sort_time+'"><span>'+(data.day||!obj.day?obj.time_formatted:days[obj.day]+"</span><span>"+obj.time_formatted)+'</span></td><td class="name" data-sort="'+obj.name+"-"+sort_time+'">'+formatLink(obj.url,highlight(obj.name,search),"post_type")+'</td><td class="location" data-sort="'+obj.location+"-"+sort_time+'">'+highlight(obj.location,search)+'</td><td class="address" data-sort="'+obj.address+"-"+sort_time+'">'+highlight(obj.address,search)+'</td><td class="region" data-sort="'+(obj.sub_region||obj.region||"")+"-"+sort_time+'">'+(obj.sub_region||obj.region||"")+'</td><td class="types visible-print-block">'+decodeMeetingTypes(obj.types)+"</td></tr>")}),sortMeetings();for(var i=0;i<markers.length;i++)markers[i].setMap(null);markers=[],bounds=new google.maps.LatLngBounds,loadMap(locations)}else{if(data.search&&("undefined"!=typeof data.day||"undefined"!=typeof data.region||"undefined"!=typeof data.time||"undefined"!=typeof data.type))return $("#day li").removeClass("active").first().addClass("active"),$("#time li").removeClass("active").first().addClass("active"),$("#region li").removeClass("active").first().addClass("active"),$("#type li").removeClass("active").first().addClass("active"),$("#day span.selected").html($("#day li:first-child a").html()),$("#time span.selected").html($("#time li:first-child a").html()),$("#region span.selected").html($("#region li:first-child a").html()),$("#type span.selected").html($("#type li:first-child a").html()),doSearch();$("#meetings table").addClass("hidden"),$("#meetings #map").addClass("hidden"),$("#alert").html("No results matched those criteria.").removeClass("hidden")}},"json")}function sortMeetings(){$sorted=$("#meetings table thead th[data-sort]").first();for(var order=($sorted.attr("class"),$sorted.attr("data-sort")),tbody=document.getElementById("meetings_tbody"),store=[],sort_index=$("#meetings table thead th").index($sorted),i=0,len=tbody.rows.length;len>i;i++){var row=tbody.rows[i];store.push([row.cells[sort_index].getAttribute("data-sort"),row])}store.sort(function(x,y){return x[0]>y[0]?"asc"==order?1:-1:x[0]<y[0]?"asc"==order?-1:1:0});for(var i=0,len=store.length;len>i;i++)tbody.appendChild(store[i][1])}function highlight(str,terms){if(!terms.length)return str;for(var i=0;i<terms.length;i++)str=str.replace(terms[i],"<mark>$1</mark>");return str}function closeFullscreen(){$("#meetings").hasClass("fullscreen")&&($("#meetings").removeClass("fullscreen"),$('a[href="#fullscreen"]').removeClass("active"),$('a[href="#fullscreen"]').parent().removeClass("active"),$("#map").css("height",550))}function updateTitle(){var string="";$("#meetings #day li.active").index()&&(string+=$("#meetings #day span.selected").text()),$("#meetings #time li.active").index()&&(string+=" "+$("#meetings #time span.selected").text()),$("#meetings #type li.active").index()&&(string+=" "+$("#meetings #type span.selected").text()),string+=" Meetings",$("#meetings #region li.active").index()&&(string+=" in "+$("#meetings #region span.selected").text()),document.title=string}function decodeMeetingTypes(codes){for(var return_types=[],i=0;i<codes.length;i++)return_types[return_types.length]=myAjax.types[codes[i]];return return_types.sort(),return_types.join(", ")}$('#meeting #feedback a[href="#report"]').click(function(e){e.preventDefault(),$(this).closest("#feedback").attr("class","form")}),$('#meeting #feedback a[href="#cancel"]').click(function(e){e.preventDefault(),$(this).closest("#feedback").attr("class","")}),$("#meeting #feedback form").validate({onfocusout:!1,onkeyup:function(){},highlight:function(element){$(element).closest("div.form-group").addClass("has-error")},unhighlight:function(element){$(element).closest("div.form-group").removeClass("has-error")},errorPlacement:function(){},submitHandler:function(form){var $form=$(form),$feedback=$form.closest("#feedback"),$alert=$feedback.find(".alert").first();return $.post(myAjax.ajaxurl,$form.serialize(),function(data){$alert.removeClass("alert-danger").addClass("alert-warning").html(data),$feedback.attr("class","confirm")}).fail(function(){$alert.removeClass("alert-warning").addClass("alert-danger").html("Email was not sent."),$feedback.attr("class","confirm")}),!1}});var userMarker;"https:"===location.protocol&&navigator.geolocation&&$("li.geolocator").removeClass("hidden"),$("#meetings table thead").on("click","th",function(){var order,sort=$(this).attr("class");order=$(this).attr("data-sort")?"asc"==$(this).attr("data-sort")?"desc":"asc":"asc",$("#meetings table thead th").removeAttr("data-sort"),$("#meetings table thead th."+sort).attr("data-sort",order),sortMeetings()}),$("#meetings #search").submit(function(){return doSearch(),!1}),$("#meetings .controls").on("click",".dropdown-menu a",function(e){e.preventDefault(),"day"==$(this).closest(".dropdown").attr("id")&&($("#day li").removeClass("active"),$("#day span.selected").html($(this).html())),"time"==$(this).closest(".dropdown").attr("id")&&($("#time li").removeClass("active"),$("#time span.selected").html($(this).html())),"region"==$(this).closest(".dropdown").attr("id")&&($("#region li").removeClass("active"),$("#region span.selected").html($(this).html())),"type"==$(this).closest(".dropdown").attr("id")&&($("#type li").removeClass("active"),$("#type span.selected").html($(this).html())),$(this).parent().toggleClass("active"),updateTitle(),doSearch()}),$("#meetings #action .toggle-view").click(function(e){e.preventDefault();var action=$(this).attr("data-id"),previous=$("#meetings").attr("data-type");if(history.pushState){var url=updateQueryString("v",action);window.history.pushState({path:url},"",url)}"list"==action?(closeFullscreen(),$("#meetings #action .toggle-view[data-id=list]").addClass("active"),$("#meetings #action .toggle-view[data-id=map]").removeClass("active")):"map"==action&&($("#meetings #action .toggle-view[data-id=map]").addClass("active"),$("#meetings #action .toggle-view[data-id=list]").removeClass("active")),$("#meetings").attr("data-type",action),"map"==action&&action!=previous&&(google.maps.event.trigger(map,"resize"),map.fitBounds(bounds),1==markers.length&&$("#map").is(":visible")&&(map.setZoom(14),google.maps.event.trigger(markers[0],"click")))}),$('a[href="#geolocator"]').click(function(e){e.preventDefault(),$(this).toggleClass("active"),$(this).hasClass("active")?navigator.geolocation.getCurrentPosition(function(position){var pos=new google.maps.LatLng(position.coords.latitude,position.coords.longitude);userMarker=new google.maps.Marker({icon:"http://maps.google.com/mapfiles/ms/icons/blue-dot.png",position:pos,map:map,title:"You"}),map.setCenter(pos),map.setZoom(13)},function(err){console.log("ERROR("+err.code+"): "+err.message),$(this).removeClass("active")}):void 0!==userMarker&&userMarker.setMap(null)}),$('a[href="#fullscreen"]').click(function(e){e.preventDefault();var center=map.getCenter();if($(this).toggleClass("active"),$(this).hasClass("active")){$("#meetings").addClass("fullscreen");var height=$(window).height()-79;$("body").hasClass("admin-bar")&&(height-=32),$("#map").css("height",height)}else closeFullscreen();google.maps.event.trigger(map,"resize"),map.setCenter(center)}),$(document).keyup(function(e){27==e.keyCode&&closeFullscreen()}),$("body").hasClass("post-type-archive-meetings")&&updateTitle(),$(window).resize(function(){if($("#meetings").hasClass("fullscreen")){var center=map.getCenter(),height=$(window).height()-79;$("body").hasClass("admin-bar")&&(height-=32),$("#map").css("height",height),google.maps.event.trigger(map,"resize"),map.setCenter(center)}})}),markers=[],map=new google.maps.Map(document.getElementById("map"),{panControl:!1,mapTypeControl:!1,mapTypeControlOptions:{mapTypeIds:[google.maps.MapTypeId.ROADMAP,"map_style"]}}),bounds=new google.maps.LatLngBounds,days=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],infowindow=new google.maps.InfoWindow;